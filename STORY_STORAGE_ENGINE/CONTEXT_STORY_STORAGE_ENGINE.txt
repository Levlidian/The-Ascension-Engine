const modificonst modifier = (text, stop) => {
  const t = state.storyEngine.time;
  const yearsPassed = Math.max(0, t.year - 2026);

  let context = `
WORLD:
Environment: ${state.storyEngine.environmentType}
Travel Mode: ${state.storyEngine.travelMode}

TIME:
${t.hour}:${String(t.minute).padStart(2,"0")}
Day ${t.day}, ${MONTHS[t.monthIndex]} ${t.year}

RESPONSE STYLE:
${state.storyEngine.responseStyle}

AMBIENT LIFE:
${state.storyEngine.sliceLife.seasonalAmbience[t.season]?.join(" ")}

NEIGHBORHOOD:
${state.storyEngine.sliceLife.neighborhoodVibes[state.storyEngine.currentDistrict]?.join(" ")}

QUIET LIFE:
${state.storyEngine.sliceLife.quietModes.join(" ")}

SOCIAL BACKGROUND:
${state.storyEngine.socialStories.streetUsage.join(" ")}

CHARACTERS PRESENT:
`;

  for (const [name,c] of Object.entries(state.storyEngine.characters)) {
    context += `
${name} (${c.role}, ${c.race})
Emotion: ${c.emotion}
Personality: ${(c.personality||[]).join(", ")}
Mannerisms: ${(c.mannerisms||[]).join(", ")}
`;
  }

  if (state.storyEngine.forceTimeReadout) {
    context += `
--- TIME CHECK ---
It is ${t.hour}:${String(t.minute).padStart(2,"0")} on Day ${t.day}.
`;
    state.storyEngine.forceTimeReadout = false;
  }

  context += `
ESCALATION: ${state.storyEngine.escalation}/5
---
`;

  text = context + text;

  if (typeof InnerSelfContext === "function") {
    [text, stop] = InnerSelfContext(text, stop);
  }

  return { text, stop };
};

modifier(text, stop);

